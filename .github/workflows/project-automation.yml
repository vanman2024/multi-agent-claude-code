name: Project Board Automation

on:
  issues:
    types: [opened, edited, labeled, unlabeled, assigned, closed, reopened]
  pull_request:
    types: [opened, edited, labeled, unlabeled, assigned, closed, merged]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to add to project'
        required: false

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  PROJECT_ID: PVT_kwHOCu1OR84BA3ip  # Multi-Agent Claude Code Development
  PROJECT_NUMBER: 11
  
  # Field IDs from our project
  STATUS_FIELD: PVTSSF_lAHOCu1OR84BA3ipzgziw9A
  PRIORITY_FIELD: PVTSSF_lAHOCu1OR84BA3ipzgzixBc
  COMPONENT_FIELD: PVTSSF_lAHOCu1OR84BA3ipzgzixC0
  
  # Status option IDs
  STATUS_TODO: f75ad846
  STATUS_IN_PROGRESS: 47fc9ee4
  STATUS_DONE: 98236657
  
  # Priority option IDs
  PRIORITY_P0: 272850f8
  PRIORITY_P1: 257f709e
  PRIORITY_P2: 5041f9b5
  PRIORITY_P3: e6ae2685
  
  # Component option IDs (we only have 4 currently, will add more as needed)
  COMPONENT_FRONTEND: 83954b68
  COMPONENT_BACKEND: 8aa84839
  COMPONENT_DATABASE: eea4cd61
  COMPONENT_DEVOPS: 82f4b58a
  # Additional components to be added to project:
  # API, Authentication, Testing, Documentation, Security, 
  # Performance, Monitoring, Analytics, Payments, Messaging,
  # Search, Storage, CDN, ML/AI, Mobile, Desktop

jobs:
  add-to-project:
    name: Add Issue/PR to Project
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' || github.event_name == 'workflow_dispatch'
    outputs:
      item-id: ${{ steps.add-to-project.outputs.itemId }}
    
    steps:
      - name: Add to project
        id: add-to-project
        uses: actions/add-to-project@v0.5.0
        with:
          project-url: https://github.com/users/${{ github.repository_owner }}/projects/${{ env.PROJECT_NUMBER }}
          github-token: ${{ secrets.PROJECT_TOKEN }}
          
      - name: Get item ID
        id: get-item
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const query = `
              query($projectId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    items(first: 100) {
                      nodes {
                        id
                        content {
                          ... on Issue {
                            id
                            number
                          }
                          ... on PullRequest {
                            id
                            number
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            const contentId = context.payload.issue?.node_id || context.payload.pull_request?.node_id;
            const variables = {
              projectId: process.env.PROJECT_ID
            };
            
            const result = await github.graphql(query, variables);
            const item = result.node.items.nodes.find(i => i.content?.id === contentId);
            
            if (item) {
              core.setOutput('itemId', item.id);
              console.log(`Found item ID: ${item.id}`);
            }
            
  set-fields:
    name: Set Project Fields
    runs-on: ubuntu-latest
    needs: add-to-project
    if: needs.add-to-project.outputs.item-id
    
    steps:
      - name: Set Priority based on labels
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const itemId = '${{ needs.add-to-project.outputs.item-id }}';
            const labels = context.payload.issue?.labels || context.payload.pull_request?.labels || [];
            
            let priorityId = process.env.PRIORITY_P3; // default
            
            // Check labels for priority indicators
            if (labels.some(l => l.name === 'critical' || l.name === 'urgent')) {
              priorityId = process.env.PRIORITY_P0;
            } else if (labels.some(l => l.name === 'high-priority')) {
              priorityId = process.env.PRIORITY_P1;
            } else {
              priorityId = process.env.PRIORITY_P3; // Default to P3
            }
            
            // Check title for priority indicators
            const title = context.payload.issue?.title || context.payload.pull_request?.title || '';
            if (title.includes('[P0]') || title.includes('[CRITICAL]')) {
              priorityId = process.env.PRIORITY_P0;
            } else if (title.includes('[P1]') || title.includes('[URGENT]')) {
              priorityId = process.env.PRIORITY_P1;
            } else if (title.includes('[P2]')) {
              priorityId = process.env.PRIORITY_P2;
            }
            
            const mutation = `
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $projectId
                  itemId: $itemId
                  fieldId: $fieldId
                  value: { singleSelectOptionId: $optionId }
                }) {
                  projectV2Item {
                    id
                  }
                }
              }
            `;
            
            await github.graphql(mutation, {
              projectId: process.env.PROJECT_ID,
              itemId: itemId,
              fieldId: process.env.PRIORITY_FIELD,
              optionId: priorityId
            });
            
            console.log(`Set priority to ${priorityId}`);
            
      - name: Set Component based on labels and content
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const itemId = '${{ needs.add-to-project.outputs.item-id }}';
            const labels = context.payload.issue?.labels || context.payload.pull_request?.labels || [];
            const body = context.payload.issue?.body || context.payload.pull_request?.body || '';
            
            let componentId = null;
            
            // Check labels for component hints (using issue type labels, not component labels)
            if (labels.some(l => l.name === 'ui' || l.name === 'ux')) {
              componentId = process.env.COMPONENT_FRONTEND;
            } else if (labels.some(l => l.name === 'api' || l.name === 'server')) {
              componentId = process.env.COMPONENT_BACKEND;
            } else if (labels.some(l => l.name === 'database' || l.name === 'db')) {
              componentId = process.env.COMPONENT_DATABASE;
            } else if (labels.some(l => l.name === 'ci' || l.name === 'cd' || l.name === 'infrastructure')) {
              componentId = process.env.COMPONENT_DEVOPS;
            }
            
            // Check body content for component mentions
            if (!componentId && body.includes('Component:')) {
              if (body.toLowerCase().includes('frontend')) {
                componentId = process.env.COMPONENT_FRONTEND;
              } else if (body.toLowerCase().includes('backend')) {
                componentId = process.env.COMPONENT_BACKEND;
              } else if (body.toLowerCase().includes('database')) {
                componentId = process.env.COMPONENT_DATABASE;
              } else if (body.toLowerCase().includes('devops')) {
                componentId = process.env.COMPONENT_DEVOPS;
              }
            }
            
            if (componentId) {
              const mutation = `
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: { singleSelectOptionId: $optionId }
                  }) {
                    projectV2Item {
                      id
                    }
                  }
                }
              `;
              
              await github.graphql(mutation, {
                projectId: process.env.PROJECT_ID,
                itemId: itemId,
                fieldId: process.env.COMPONENT_FIELD,
                optionId: componentId
              });
              
              console.log(`Set component to ${componentId}`);
            }
            
      - name: Set Initial Status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const itemId = '${{ needs.add-to-project.outputs.item-id }}';
            
            // Default to TODO for new items
            let statusId = process.env.STATUS_TODO;
            
            // If it's a PR, set to In Progress
            if (context.payload.pull_request) {
              statusId = process.env.STATUS_IN_PROGRESS;
            }
            
            const mutation = `
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $projectId
                  itemId: $itemId
                  fieldId: $fieldId
                  value: { singleSelectOptionId: $optionId }
                }) {
                  projectV2Item {
                    id
                  }
                }
              }
            `;
            
            await github.graphql(mutation, {
              projectId: process.env.PROJECT_ID,
              itemId: itemId,
              fieldId: process.env.STATUS_FIELD,
              optionId: statusId
            });
            
            console.log(`Set status to ${statusId}`);

  create-branch:
    name: Create Development Branch
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Create branch
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            
            // Determine branch type from labels and title
            let branchType = 'task';
            if (issue.title.includes('[FEATURE]') || issue.labels.some(l => l.name === 'enhancement')) {
              branchType = 'feature';
            } else if (issue.title.includes('[BUG]') || issue.labels.some(l => l.name === 'bug')) {
              branchType = 'bug';
            }
            
            // Create branch name
            const title = issue.title.replace(/\[.*?\]/g, '').trim().toLowerCase().replace(/[^a-z0-9]/g, '-').substring(0, 30);
            const branchName = `${branchType}/${issue.number}-${title}`;
            
            try {
              // Get default branch
              const { data: repo } = await github.rest.repos.get({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              
              const { data: ref } = await github.rest.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${repo.default_branch}`
              });
              
              // Create new branch
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/heads/${branchName}`,
                sha: ref.object.sha
              });
              
              console.log(`Created branch: ${branchName}`);
              
              // Add comment to issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `## 🌿 Development branch created\n\n**Branch:** \`${branchName}\`\n\nTo start working on this issue:\n\`\`\`bash\ngit fetch origin\ngit checkout ${branchName}\n\`\`\`\n\nWhen ready, create a PR with:\n\`\`\`bash\ngh pr create --base main --head ${branchName} --title "Fixes #${issue.number}" --body "Closes #${issue.number}"\n\`\`\``
              });
            } catch (error) {
              console.log('Branch creation failed:', error.message);
            }

  update-status-on-progress:
    name: Update Status on Progress
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'issues' && github.event.action == 'assigned') ||
      (github.event_name == 'pull_request' && github.event.action == 'opened')
    
    steps:
      - name: Move to In Progress
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            // Get the issue number
            let issueNumber;
            if (context.payload.issue) {
              issueNumber = context.payload.issue.number;
            } else if (context.payload.pull_request) {
              // Extract issue number from PR body or title
              const prBody = context.payload.pull_request.body || '';
              const prTitle = context.payload.pull_request.title || '';
              const match = (prBody + prTitle).match(/#(\d+)/);
              if (match) {
                issueNumber = match[1];
              }
            }
            
            if (!issueNumber) return;
            
            // Find the project item
            const query = `
              query {
                repository(owner: "${{ github.repository_owner }}", name: "${{ github.event.repository.name }}") {
                  issue(number: ${issueNumber}) {
                    projectItems(first: 10) {
                      nodes {
                        id
                        project {
                          id
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            const result = await github.graphql(query);
            const projectItem = result.repository.issue.projectItems.nodes.find(
              item => item.project.id === process.env.PROJECT_ID
            );
            
            if (projectItem) {
              const mutation = `
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: { singleSelectOptionId: $optionId }
                  }) {
                    projectV2Item {
                      id
                    }
                  }
                }
              `;
              
              await github.graphql(mutation, {
                projectId: process.env.PROJECT_ID,
                itemId: projectItem.id,
                fieldId: process.env.STATUS_FIELD,
                optionId: process.env.STATUS_IN_PROGRESS
              });
              
              console.log('Moved to In Progress');
            }

  update-status-on-close:
    name: Update Status on Close
    runs-on: ubuntu-latest
    if: |
      (github.event.action == 'closed') ||
      (github.event_name == 'pull_request' && github.event.action == 'merged')
    
    steps:
      - name: Move to Done
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const contentId = context.payload.issue?.node_id || context.payload.pull_request?.node_id;
            
            const query = `
              query($projectId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    items(first: 100) {
                      nodes {
                        id
                        content {
                          ... on Issue {
                            id
                          }
                          ... on PullRequest {
                            id
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            const result = await github.graphql(query, {
              projectId: process.env.PROJECT_ID
            });
            
            const item = result.node.items.nodes.find(i => i.content?.id === contentId);
            
            if (item) {
              const mutation = `
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: { singleSelectOptionId: $optionId }
                  }) {
                    projectV2Item {
                      id
                    }
                  }
                }
              `;
              
              await github.graphql(mutation, {
                projectId: process.env.PROJECT_ID,
                itemId: item.id,
                fieldId: process.env.STATUS_FIELD,
                optionId: process.env.STATUS_DONE
              });
              
              console.log('Moved to Done');
            }