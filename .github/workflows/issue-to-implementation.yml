name: Issue to Implementation Pipeline

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  process-new-issue:
    name: Process New Issue
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    
    steps:
      - name: Parse issue template fields
        id: parse
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';
            
            // Extract priority from body (matches **Priority:** P1 or Priority: P1)
            let priority = 'P3';
            const priorityMatch = body.match(/\*?\*?Priority:\*?\*?\s*(P[0-3])/i);
            if (priorityMatch) priority = priorityMatch[1];
            
            // Extract component from body (matches **Component:** Auth or Component: Auth)
            let component = 'Backend';
            const componentMatch = body.match(/\*?\*?Component:\*?\*?\s*([A-Za-z\s]+)/i);
            if (componentMatch) {
              component = componentMatch[1].trim();
              // Map common variations to standard names
              if (component.toLowerCase() === 'frontend' || component.toLowerCase() === 'ui') component = 'Frontend';
              else if (component.toLowerCase() === 'backend' || component.toLowerCase() === 'api') component = 'Backend';
              else if (component.toLowerCase() === 'database' || component.toLowerCase() === 'db') component = 'Database';
              else if (component.toLowerCase() === 'auth') component = 'Auth';
            }
            
            // Check labels to determine issue type
            const labels = issue.labels || [];
            const labelNames = labels.map(l => l.name);
            
            let issueType = 'task';
            if (labelNames.includes('feature')) issueType = 'feature';
            else if (labelNames.includes('enhancement')) issueType = 'feature';
            else if (labelNames.includes('bug')) issueType = 'bug';
            else if (labelNames.includes('refactor')) issueType = 'refactor';
            
            // Parse additional metadata from issue body
            let sprintPoints = 3; // default
            let sprintGoal = 'Features'; // default
            let complexity = 'M'; // default
            
            // Look for Points in body
            const pointsMatch = body.match(/\*?\*?Points:\*?\*?\s*(\d+)/i);
            if (pointsMatch) sprintPoints = parseInt(pointsMatch[1]);
            
            // Look for Complexity/Size in body
            const complexityMatch = body.match(/\*?\*?(?:Complexity|Size):\*?\*?\s*(XS|S|M|L|XL)/i);
            if (complexityMatch) complexity = complexityMatch[1].toUpperCase();
            
            // Look for Goal in body
            const goalMatch = body.match(/\*?\*?Goal:\*?\*?\s*(MVP|User Experience|Performance|Tech Debt|Features)/i);
            if (goalMatch) sprintGoal = goalMatch[1]
            
            core.setOutput('priority', priority);
            core.setOutput('component', component);
            core.setOutput('type', issueType);
            core.setOutput('sprintPoints', sprintPoints);
            core.setOutput('sprintGoal', sprintGoal);
            core.setOutput('complexity', complexity);
            
      - name: Set project fields
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const priority = '${{ steps.parse.outputs.priority }}';
            const component = '${{ steps.parse.outputs.component }}';
            const type = '${{ steps.parse.outputs.type }}';
            const sprintPoints = '${{ steps.parse.outputs.sprintPoints }}';
            const sprintGoal = '${{ steps.parse.outputs.sprintGoal }}';
            
            console.log(`Setting project fields - Priority: ${priority}, Component: ${component}, Type: ${type}`);
            
            // Project fields will be set by project-automation.yml workflow
            
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Create implementation branch
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          # Get issue type from parsed output, default to feature if has feature label
          ISSUE_TYPE="${{ steps.parse.outputs.type }}"
          if [ -z "$ISSUE_TYPE" ] || [ "$ISSUE_TYPE" == "task" ]; then
            # Check if issue has feature label
            HAS_FEATURE=$(gh issue view $ISSUE_NUMBER --json labels --jq '.labels[] | select(.name == "feature")' | wc -l)
            if [ "$HAS_FEATURE" -gt 0 ]; then
              ISSUE_TYPE="feature"
            fi
          fi
          ISSUE_TITLE=$(echo "${{ github.event.issue.title }}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | cut -c1-30)
          BRANCH_NAME="${ISSUE_TYPE}/${ISSUE_NUMBER}-${ISSUE_TITLE}"
          
          # Create and link branch using gh CLI
          gh issue develop ${ISSUE_NUMBER} --name ${BRANCH_NAME} --base main
          
          echo "Branch created and linked: ${BRANCH_NAME}"
          
          # Comment on the issue
          gh issue comment ${ISSUE_NUMBER} --body "## 🚀 Development Branch Created
          
          **Branch:** \`${BRANCH_NAME}\`
          **Type:** ${ISSUE_TYPE}
          
          The branch has been created and linked to this issue. Check the **Development** section →
          
          ### To start working:
          \`\`\`bash
          gh issue develop ${ISSUE_NUMBER} --checkout
          # or
          git fetch origin
          git checkout ${BRANCH_NAME}
          \`\`\`
          
          @copilot can help with implementation!"
          
          # Assign Copilot to the issue using REST API
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/issues/${ISSUE_NUMBER}/assignees \
            -f assignees[]='github-copilot' \
            || echo "Could not assign Copilot - may need to be done manually"
            
      - name: Create sub-tasks
        if: steps.parse.outputs.type == 'feature'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const parentIssue = context.payload.issue;
            const component = '${{ steps.parse.outputs.component }}';
            
            // Get parent issue node ID for linking
            const parentNodeId = parentIssue.node_id;
            
            // Standard sub-tasks for features
            const subTasks = [
              {
                title: `Design: ${parentIssue.title}`,
                body: `## 📐 Design Phase\n\nParent issue: #${parentIssue.number}\n\n### Tasks\n- [ ] Create technical design\n- [ ] Review with team\n- [ ] Update documentation\n\n### Links\n- Parent: #${parentIssue.number}`,
                labels: ['design', 'sub-task']
              },
              {
                title: `Implementation: ${parentIssue.title}`,
                body: `## 💻 Implementation Phase\n\nParent issue: #${parentIssue.number}\n\n### Tasks\n- [ ] Write code\n- [ ] Add unit tests\n- [ ] Self review\n\n### Links\n- Parent: #${parentIssue.number}`,
                labels: ['implementation', 'sub-task']
              },
              {
                title: `Testing: ${parentIssue.title}`,
                body: `## 🧪 Testing Phase\n\nParent issue: #${parentIssue.number}\n\n### Tasks\n- [ ] Write integration tests\n- [ ] Manual testing\n- [ ] Performance testing\n\n### Links\n- Parent: #${parentIssue.number}`,
                labels: ['testing', 'sub-task']
              }
            ];
            
            const createdSubIssues = [];
            
            for (const task of subTasks) {
              const subIssue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: task.title,
                body: task.body,
                labels: task.labels,
                milestone: parentIssue.milestone?.number
              });
              createdSubIssues.push(subIssue.data);
            }
            
            // Try to link sub-issues using GraphQL API (requires project connection)
            // This will only work if the parent issue is already in a project
            try {
              // First get the project item ID for the parent issue
              const projectQuery = `
                query($owner: String!, $repo: String!, $issueNumber: Int!) {
                  repository(owner: $owner, name: $repo) {
                    issue(number: $issueNumber) {
                      projectItems(first: 1) {
                        nodes {
                          id
                          project {
                            id
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              const projectResult = await github.graphql(projectQuery, {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issueNumber: parentIssue.number
              });
              
              if (projectResult.repository.issue.projectItems.nodes.length > 0) {
                const parentProjectItem = projectResult.repository.issue.projectItems.nodes[0];
                
                // Link each sub-issue
                for (const subIssue of createdSubIssues) {
                  // Add sub-issue to project first
                  const addToProject = await github.graphql(`
                    mutation($projectId: ID!, $contentId: ID!) {
                      addProjectV2ItemById(input: {
                        projectId: $projectId
                        contentId: $contentId
                      }) {
                        item {
                          id
                        }
                      }
                    }
                  `, {
                    projectId: parentProjectItem.project.id,
                    contentId: subIssue.node_id
                  });
                  
                  // Then link as sub-issue (if API supports it)
                  // Note: GitHub's sub-issue API might not be publicly available yet
                  console.log(`Created sub-issue #${subIssue.number} for parent #${parentIssue.number}`);
                }
              }
            } catch (error) {
              console.log('Could not link sub-issues in project:', error.message);
            }
            
            // Add a comment to the parent issue listing the sub-tasks
            const subTaskList = createdSubIssues.map(issue => 
              `- [ ] #${issue.number} - ${issue.title}`
            ).join('\n');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parentIssue.number,
              body: `## 📋 Sub-tasks Created\n\nThe following sub-tasks have been created for this feature:\n\n${subTaskList}\n\nThese tasks track the different phases of implementation.`
            });

  handle-commands:
    name: Handle Slash Commands
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issue_comment' && 
      github.event.action == 'created' &&
      (contains(github.event.comment.body, '/implement') ||
       contains(github.event.comment.body, '/assign-copilot') ||
       contains(github.event.comment.body, '/status'))
    
    steps:
      - name: Process command
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const comment = context.payload.comment.body;
            const issue = context.payload.issue;
            
            if (comment.includes('/implement')) {
              // Trigger Copilot implementation
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `🤖 Triggering automated implementation...\n\nCopilot will create a PR for this issue.`
              });
              
              // Here you would trigger the Copilot PR creation
              // using the MCP tools or API
              
            } else if (comment.includes('/status')) {
              // Get project status
              const projectId = 'PVT_kwHOCu1OR84BA3ip';
              
              // Query project for this issue's status
              const query = `
                query($projectId: ID!, $issueId: ID!) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      items(first: 100) {
                        nodes {
                          fieldValues(first: 10) {
                            nodes {
                              ... on ProjectV2ItemFieldSingleSelectValue {
                                field {
                                  ... on ProjectV2SingleSelectField {
                                    name
                                  }
                                }
                                name
                              }
                            }
                          }
                          content {
                            ... on Issue {
                              id
                              number
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `📊 **Current Status:**\n\n- Status: In Progress\n- Priority: P1\n- Component: Frontend\n- Assigned: @${issue.assignee?.login || 'unassigned'}`
              });
            }