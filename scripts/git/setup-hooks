#!/bin/bash
# Setup Git Hooks for Professional Commit Strategy
# Installs the pre-push hook for commit accumulation guidance

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TEMPLATE_DIR="$(dirname "$(dirname "$SCRIPT_DIR")")"

echo "ğŸ”§ Setting up Git hooks for professional workflow..."

# Ensure .git/hooks directory exists
mkdir -p .git/hooks

# Copy pre-push hook from templates
if [ -f "$TEMPLATE_DIR/templates/git/hooks/pre-push" ]; then
    cp "$TEMPLATE_DIR/templates/git/hooks/pre-push" .git/hooks/
    chmod +x .git/hooks/pre-push
    echo "âœ… Pre-push hook installed"
else
    echo "âš ï¸  Pre-push hook template not found, creating basic version..."
    
    # Create basic hook if template not available
    cat > .git/hooks/pre-push << 'EOF'
#!/bin/bash
# Smart Pre-Push Hook: Professional Commit Accumulation Guidance

BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Skip for non-main branches
if [ "$BRANCH" != "main" ]; then
    exit 0
fi

UNPUSHED_COUNT=$(git rev-list --count @{upstream}..HEAD 2>/dev/null || echo 0)

if [ "$UNPUSHED_COUNT" -le 1 ]; then
    echo "ğŸ¤– Professional Commit Strategy Guidance"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“Š Commits to push: $UNPUSHED_COUNT"
    echo ""
    echo "ğŸ’¡ For richer release notes, consider accumulating 3-6 commits first"
    echo "ğŸš€ Continue anyway? Proceeding in 3 seconds..."
    read -t 3 -p "" || true
    echo ""
fi

echo "âœ… Proceeding with push..."
exit 0
EOF
    chmod +x .git/hooks/pre-push
    echo "âœ… Basic pre-push hook created"
fi

# Verify hook is working
if [ -x .git/hooks/pre-push ]; then
    echo "âœ… Git hooks setup complete!"
    echo ""
    echo "ğŸ“‹ Professional commit workflow enabled:"
    echo "  â€¢ Guidance for commit accumulation on main branch"
    echo "  â€¢ Use './scripts/git/push-bypass' for quick testing"
    echo "  â€¢ Use 'git push --no-verify' to bypass hook"
else
    echo "âŒ Failed to setup git hooks"
    exit 1
fi